name: release
concurrency: release
on:
  push:
    branches:
      - omaster
jobs:
  version:
    runs-on: ubuntu-latest
    name: Version and Sonar
    outputs:
      semVer: ${{ steps.gitversion.outputs.semVer }}
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: gittools/actions/gitversion/setup@v0.9.10
        with:
          versionSpec: 5.7.0
      - id: gitversion
        uses: gittools/actions/gitversion/execute@v0.9.10
        with:
          useConfigFile: true
      - name: Sonar cache
        id: cache-sonar
        uses: actions/cache@v2
        with:
          path: /opt/sonar-scanner
          key: ${{ runner.os }}-sonar
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        with:
          args: >
            -Dsonar.projectVersion=${{ steps.gitversion.outputs.semVer }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.9'
      - uses: pre-commit/action@v2.0.3

  python-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.9'
      - name: Install tox
        run: pip install tox
      - name: Prepare test environment
        working-directory: block_pvc_scanner
        run: tox --notest -p auto --parallel-live
      - name: TOX
        working-directory: block_pvc_scanner
        run: tox

  python-release:
    runs-on: ubuntu-latest
    name: Python release
    needs:
      - version
      - pre-commit
      - python-test
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.9'
      - name: VERSION file block-pvc-scanner
        run: |
          echo "__version__ = '${{ needs.version.outputs.semVer }}'" > block_pvc_scanner/src/block_pvc_scanner/_version.py
      - name: VERSION file pod-pvc-mapping
        run: |
          echo "__version__ = '${{ needs.version.outputs.semVer }}'" > pod_pvc_mapping/src/pod_pvc_mapping/_version.py
      - name: build deps
        run: |
          python3 -m pip install --upgrade build
      - name: build Python package block-pvc-scanner
        working-directory: block_pvc_scanner
        run: python3 -m build --sdist
      - name: build Python package pod-pvc-mapping
        working-directory: pod_pvc_mapping
        run: python3 -m build --sdist

      - uses: ncipollo/release-action@v1
        with:
          artifacts: "block_pvc_scanner/dist/*.tar.gz,pod_pvc_mapping/dist/*.tar.gz"
          tag: ${{ needs.version.outputs.semVer }}
          commit: ${{ github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

  docker-release-bps:
    runs-on: ubuntu-latest
    name: Docker block-pvc-scanner
    needs:
      - version
      - pre-commit
      - python-test
    steps:
      - uses: actions/checkout@v2
      - name: VERSION file block-pvc-scanner
        run: |
          echo "__version__ = '${{ needs.version.outputs.semVer }}'" > block_pvc_scanner/src/block_pvc_scanner/_version.py

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        id: qemu
        uses: docker/setup-qemu-action@v1
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1

      - name: Docker build and push block-pvc-scanner
        id: docker_build_block_pvc_scanner
        uses: docker/build-push-action@v2
        with:
          context: ./block_pvc_scanner
          file: ./block_pvc_scanner/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          builder: ${{ steps.buildx.outputs.name }}
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/block-pvc-scanner:${{ needs.version.outputs.semVer }}
            ${{ secrets.DOCKER_HUB_USERNAME }}/block-pvc-scanner:latest
            ghcr.io/${{ github.repository_owner }}/block-pvc-scanner:${{ needs.version.outputs.semVer }}
          cache-from: type=gha, scope=${{ github.workflow }}-bps
          cache-to: type=gha, scope=${{ github.workflow }}-bps

  docker-release-ppm:
    runs-on: ubuntu-latest
    name: Docker pod-pvc-mapping
    needs:
      - version
      - pre-commit
      - python-test
    steps:
      - uses: actions/checkout@v2
      - name: VERSION file pod-pvc-mapping
        run: |
          echo "__version__ = '${{ needs.version.outputs.semVer }}'" > pod_pvc_mapping/src/pod_pvc_mapping/_version.py

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        id: qemu
        uses: docker/setup-qemu-action@v1
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1

      - name: Docker build and push pod-pvc-mapping
        id: docker_build_pod_pvc_mapping
        uses: docker/build-push-action@v2
        with:
          context: ./pod_pvc_mapping
          file: ./pod_pvc_mapping/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          builder: ${{ steps.buildx.outputs.name }}
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/pod-pvc-mapping:${{ needs.version.outputs.semVer }}
            ${{ secrets.DOCKER_HUB_USERNAME }}/pod-pvc-mapping:latest
            ghcr.io/${{ github.repository_owner }}/pod-pvc-mapping:${{ needs.version.outputs.semVer }}
          cache-from: type=gha, scope=${{ github.workflow }}-ppm
          cache-to: type=gha, scope=${{ github.workflow }}-ppm

  helm-release:
    runs-on: ubuntu-latest
    name: Helm release
    needs:
      - version
      - python-release
      - docker-release-bps
      - docker-release-ppm
    steps:
      - uses: actions/checkout@v2
      - name: Update chart version in the related HelmChart Charts.yaml
        uses: fjogeleit/yaml-update-action@master
        with:
          valueFile: 'charts/pvc-exporter/Chart.yaml'
          propertyPath: 'version'
          value: ${{ needs.version.outputs.semVer }}
          createPR: false
          commitChange: false
          updateFile: true
          message: 'Update chart version to ${{ needs.version.outputs.version }}'
      - name: Update appVersion in the related HelmChart Charts.yaml
        uses: fjogeleit/yaml-update-action@master
        with:
          valueFile: 'charts/pvc-exporter/Chart.yaml'
          propertyPath: 'appVersion'
          value: ${{ needs.version.outputs.semVer }}
          createPR: false
          commitChange: false
          updateFile: true
          message: 'Update appVersion to ${{ needs.version.outputs.version }}'

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - uses: azure/setup-helm@v1
        with:
          version: v3.6.3

      - uses: helm/chart-releaser-action@v1.2.1
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
